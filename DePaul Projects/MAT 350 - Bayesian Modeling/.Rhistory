te_lower = te_ci[,1],
te_upper = te_ci[,2]
))
}
# Get individual effects
effects <- get_individual_effects(data_prepared$data_prep)
# Add effects to original data
results <- data %>%
mutate(
individual_te = effects$treatment_effect,
baseline_risk = effects$baseline_risk,
te_lower = effects$te_lower,
te_upper = effects$te_upper
)
# Create risk groups
results <- results %>%
mutate(
risk_group = cut(baseline_risk,
breaks = quantile(baseline_risk, probs = seq(0, 1, length.out = n_groups + 1)),
labels = paste("Q", 1:n_groups, sep=""),
include.lowest = TRUE)
)
# Subgroup analysis by risk groups
risk_subgroups <- results %>%
group_by(risk_group) %>%
summarise(
n = n(),
mean_risk = mean(baseline_risk),
mean_te = mean(individual_te),
te_sd = sd(individual_te),
te_lower = mean(te_lower),
te_upper = mean(te_upper),
.groups = 'drop'
) %>%
arrange(mean_risk)
# Test for treatment effect heterogeneity across risk groups
het_test <- lm(individual_te ~ risk_group, data = results)
het_anova <- anova(het_test)
# Create visualization of risk group effects
te_plot <- ggplot(risk_subgroups, aes(x = risk_group, y = mean_te)) +
geom_point(size = 3) +
geom_errorbar(aes(ymin = te_lower, ymax = te_upper), width = 0.2) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
labs(x = "Risk Quintile",
y = "Treatment Effect",
title = "Treatment Effects by Risk Group") +
theme_minimal() +
coord_flip()
# Subgroup analysis by key factors
subgroup_analysis <- results %>%
group_by(anticoagulant, diabetes) %>%
summarise(
n = n(),
mean_te = mean(individual_te),
te_sd = sd(individual_te),
mean_risk = mean(baseline_risk),
te_lower = mean(te_lower),
te_upper = mean(te_upper),
.groups = 'drop'
) %>%
arrange(desc(mean_te))
# Create forest plot
forest_plot <- ggplot(subgroup_analysis,
aes(y = reorder(paste(anticoagulant, diabetes), mean_te),
x = mean_te)) +
geom_point(size = 3) +
geom_errorbarh(aes(xmin = te_lower, xmax = te_upper), height = 0.2) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
labs(x = "Treatment Effect", y = "Subgroup",
title = "Treatment Effects by Key Subgroups") +
theme_minimal()
return(list(
individual_results = results,
risk_subgroups = risk_subgroups,
subgroup_analysis = subgroup_analysis,
heterogeneity_test = het_anova,
risk_plot = te_plot,
forest_plot = forest_plot
))
}
# Run the analysis
te_analysis <- analyze_treatment_effects(binary_samples, rct_data)
# Print formatted results
cat("\nRisk Group Analysis:\n")
print(te_analysis$risk_subgroups %>%
select(risk_group, n, mean_risk, mean_te, te_lower, te_upper) %>%
mutate(across(where(is.numeric), ~round(., 3))))
# Run the analysis
te_analysis <- analyze_treatment_effects(binary_samples, rct_data)
# Print formatted results
cat("\nRisk Group Analysis:\n")
print(te_analysis$risk_subgroups %>%
select(risk_group, n, mean_risk, mean_te, te_lower, te_upper) %>%
mutate(across(where(is.numeric), ~round(., 3))))
# Run the analysis
te_analysis <- analyze_treatment_effects(binary_samples, rct_data)
# Print formatted results using explicit dplyr functions
cat("\nRisk Group Analysis:\n")
print(te_analysis$risk_subgroups %>%
dplyr::select(risk_group, n, mean_risk, mean_te, te_lower, te_upper) %>%
dplyr::mutate(across(where(is.numeric), ~round(., 3))))
cat("\nSubgroup Analysis:\n")
print(te_analysis$subgroup_analysis %>%
dplyr::select(anticoagulant, diabetes, n, mean_te, te_lower, te_upper) %>%
dplyr::mutate(across(where(is.numeric), ~round(., 3))))
cat("\nTest for Treatment Effect Heterogeneity:\n")
print(te_analysis$heterogeneity_test)
# Display plots
print(te_analysis$risk_plot)
print(te_analysis$forest_plot)
# Create a risk distribution plot with explicit ggplot calls
risk_dist_plot <- ggplot(te_analysis$individual_results,
aes(x = baseline_risk, fill = risk_group)) +
geom_histogram(bins = 30, alpha = 0.7) +
labs(x = "Baseline Risk", y = "Count",
title = "Distribution of Baseline Risk Scores") +
theme_minimal()
print(risk_dist_plot)
# Save results to a data frame for further analysis if needed
results_df <- te_analysis$individual_results %>%
dplyr::select(
age, gender, anticoagulant, diabetes,
baseline_risk, individual_te, te_lower, te_upper,
risk_group
)
# Summary statistics by risk group
risk_summary <- results_df %>%
group_by(risk_group) %>%
summarise(
n_patients = n(),
mean_risk = mean(baseline_risk),
mean_effect = mean(individual_te),
lower_ci = mean(te_lower),
upper_ci = mean(te_upper)
) %>%
mutate(across(where(is.numeric), ~round(., 3)))
print("Risk Group Summary:")
print(risk_summary)
# Summary statistics by key subgroups
subgroup_summary <- results_df %>%
group_by(anticoagulant, diabetes) %>%
summarise(
n_patients = n(),
mean_risk = mean(baseline_risk),
mean_effect = mean(individual_te),
lower_ci = mean(te_lower),
upper_ci = mean(te_upper)
) %>%
mutate(across(where(is.numeric), ~round(., 3)))
print("Subgroup Summary:")
print(subgroup_summary)
install.packages('tableone')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rjags)
library(MASS)
library(LaplacesDemon)
library(survival)
library(survminer)
library(survRM2)
library(rjags)
# Function to generate synthetic RCT data
generate_synthetic_rct <- function(n_subjects = 1000, max_followup = 365 * 3) {
# Set seed for reproducibility
set.seed(123)
# Generate basic demographic covariates
age <- rnorm(n_subjects, mean = 55, sd = 12)
age <- pmax(pmin(age, 85), 25)  # Truncate age between 25 and 85
gender <- rbinom(n_subjects, 1, 0.52)  # Slightly more females
# Generate correlated blood pressure variables
bp_matrix <- MASS::mvrnorm(n_subjects,
mu = c(130, 80),  # Mean SBP and DBP
Sigma = matrix(c(200, 100,  # Correlation matrix
100, 100), 2, 2))
sbp <- bp_matrix[,1]
dbp <- bp_matrix[,2]
# Generate BMI with realistic distribution
bmi <- rnorm(n_subjects, mean = 28, sd = 5)
bmi <- pmax(pmin(bmi, 50), 16)  # Truncate BMI between 16 and 50
# Generate binary comorbidities with some correlation
hypertension <- ifelse(sbp >= 140 | dbp >= 90, 1, 0)
diabetes <- rbinom(n_subjects, 1, 0.2 + 0.2 * (bmi > 30))
smoking <- rbinom(n_subjects, 1, 0.25 - 0.1 * (age > 65))
# Additional risk factors
anticoagulant <- rbinom(n_subjects, 1, 0.3)
prior_bleeding <- rbinom(n_subjects, 1, 0.1)
# Treatment assignment
treatment <- rbinom(n_subjects, 1, 0.5)
# Generate baseline risk
baseline_risk <- plogis(-3.5 +
0.02 * (age - 55) +
0.8 * anticoagulant +
1.2 * prior_bleeding +
0.3 * diabetes +
0.01 * (sbp - 130))
# Treatment effects with heterogeneity
treatment_effect <- 0.5 +
0.3 * (age > 65) +
0.4 * anticoagulant +
0.2 * (bmi > 30)
# Generate outcome
event_prob <- plogis(logit(baseline_risk) + treatment * treatment_effect)
event <- rbinom(n_subjects, 1, event_prob)
# Create data frame
data <- data.frame(
subject_id = 1:n_subjects,
age = round(age, 1),
gender = factor(gender, labels = c("Male", "Female")),
bmi = round(bmi, 1),
sbp = round(sbp),
dbp = round(dbp),
hypertension = factor(hypertension, labels = c("No", "Yes")),
diabetes = factor(diabetes, labels = c("No", "Yes")),
smoking = factor(smoking, labels = c("No", "Yes")),
anticoagulant = factor(anticoagulant, labels = c("No", "Yes")),
prior_bleeding = factor(prior_bleeding, labels = c("No", "Yes")),
treatment = factor(treatment, labels = c("Control", "Treatment")),
event = event
)
return(data)
}
# Function to prepare data for JAGS
prepare_data <- function(data) {
# Standardize continuous variables
data_prep <- data %>%
mutate(
treatment = as.numeric(treatment) - 1,
age_s = as.vector(scale(age)),
bmi_s = as.vector(scale(bmi)),
sbp_s = as.vector(scale(sbp)),
anticoag = as.numeric(anticoagulant) - 1,
diabetes = as.numeric(diabetes) - 1,
prior_bleeding = as.numeric(prior_bleeding) - 1,
gender = as.numeric(gender) - 1,
status = event
)
# Create data list for JAGS
jags_data <- list(
N = nrow(data_prep),
treatment = data_prep$treatment,
age = data_prep$age_s,
bmi = data_prep$bmi_s,
anticoag = data_prep$anticoag,
diabetes = data_prep$diabetes,
prior_bleeding = data_prep$prior_bleeding,
gender = data_prep$gender,
y = data_prep$status,
n_gender = 2
)
return(list(jags_data = jags_data, data_prep = data_prep))
}
# JAGS model specification
binary_model_string <- "
model {
# Likelihood
for (i in 1:N) {
y[i] ~ dbern(p[i])
logit(p[i]) <- mu[i]
mu[i] <- b_intercept +
b_trt * treatment[i] +
b_age * age[i] +
b_anticoag * anticoag[i] +
b_diabetes * diabetes[i] +
b_prior * prior_bleeding[i] +
b_bmi * bmi[i] +
# Treatment interactions
b_trt_age * treatment[i] * age[i] +
b_trt_anticoag * treatment[i] * anticoag[i] +
b_trt_diabetes * treatment[i] * diabetes[i] +
# Random effects
re[gender[i] + 1] +
re_trt[gender[i] + 1] * treatment[i]
}
# Priors for fixed effects
b_intercept ~ dnorm(0, 1)
b_trt ~ dnorm(0, 1)
b_age ~ dnorm(0, 1)
b_anticoag ~ dnorm(0, 1)
b_diabetes ~ dnorm(0, 1)
b_prior ~ dnorm(0, 1)
b_bmi ~ dnorm(0, 1)
# Priors for interaction effects
b_trt_age ~ dnorm(0, 1)
b_trt_anticoag ~ dnorm(0, 1)
b_trt_diabetes ~ dnorm(0, 1)
# Random effects for gender
for (k in 1:n_gender) {
re[k] ~ dnorm(0, tau_re)
re_trt[k] ~ dnorm(0, tau_re_trt)
}
# Hyperpriors for random effects
tau_re ~ dgamma(2, 2)
tau_re_trt ~ dgamma(2, 2)
# Calculate gender-specific treatment effects
for (k in 1:n_gender) {
te_gender[k] <- b_trt + re_trt[k]
}
}
"
# Function to run JAGS model
run_jags_model <- function(data_list, model_string, n.chains = 3) {
# Initialize model with conservative initial values
inits <- function() {
list(
b_intercept = rnorm(1, 0, 0.1),
b_trt = rnorm(1, 0, 0.1),
b_age = rnorm(1, 0, 0.1),
b_anticoag = rnorm(1, 0, 0.1),
b_diabetes = rnorm(1, 0, 0.1),
b_prior = rnorm(1, 0, 0.1),
b_bmi = rnorm(1, 0, 0.1),
b_trt_age = rnorm(1, 0, 0.1),
b_trt_anticoag = rnorm(1, 0, 0.1),
b_trt_diabetes = rnorm(1, 0, 0.1),
tau_re = 1,
tau_re_trt = 1
)
}
# Initialize model
jags_model <- jags.model(
textConnection(model_string),
data = data_list,
inits = inits,
n.chains = n.chains,
n.adapt = 2000
)
# Burn-in
update(jags_model, 5000)
# Parameters to monitor
params <- c("b_intercept", "b_trt", "b_age", "b_anticoag", "b_diabetes",
"b_prior", "b_bmi", "b_trt_age", "b_trt_anticoag",
"b_trt_diabetes", "te_gender")
# Sample from posterior
mcmc_samples <- coda.samples(
jags_model,
variable.names = params,
n.iter = 10000,
thin = 10
)
return(mcmc_samples)
}
# Function to calculate treatment effects for subgroups
calculate_subgroup_effects <- function(mcmc_samples, subgroup_values) {
# Extract samples
samples <- as.matrix(mcmc_samples)
# Calculate treatment effects
te_samples <- samples[, "b_trt"] +
samples[, "b_trt_age"] * subgroup_values$age +
samples[, "b_trt_anticoag"] * subgroup_values$anticoag +
samples[, "b_trt_diabetes"] * subgroup_values$diabetes
# Transform to probability scale
te_prob <- plogis(te_samples) - plogis(rep(0, length(te_samples)))
# Summarize
te_summary <- c(
mean = mean(te_prob),
quantile(te_prob, probs = c(0.025, 0.975))
)
return(te_summary)
}
# Function to create diagnostic plots
create_diagnostic_plots <- function(mcmc_samples) {
# Trace plots
par(mfrow = c(3, 2))
traceplot(mcmc_samples[, c("b_trt", "b_trt_age", "b_trt_anticoag",
"b_trt_diabetes", "te_gender[1]", "te_gender[2]")])
# Density plots
par(mfrow = c(3, 2))
plot(density(as.matrix(mcmc_samples)[, "b_trt"]), main = "Treatment Effect")
plot(density(as.matrix(mcmc_samples)[, "b_trt_age"]), main = "Treatment-Age Interaction")
plot(density(as.matrix(mcmc_samples)[, "b_trt_anticoag"]), main = "Treatment-Anticoag Interaction")
plot(density(as.matrix(mcmc_samples)[, "b_trt_diabetes"]), main = "Treatment-Diabetes Interaction")
plot(density(as.matrix(mcmc_samples)[, "te_gender[1]"]), main = "TE Males")
plot(density(as.matrix(mcmc_samples)[, "te_gender[2]"]), main = "TE Females")
}
# Function to create effect plots
create_effect_plots <- function(mcmc_samples, data_prep) {
# Calculate treatment effects across age range
age_seq <- seq(-2, 2, length.out = 100)
te_age <- sapply(age_seq, function(a) {
subgroup_values <- list(age = a, anticoag = 0, diabetes = 0)
calculate_subgroup_effects(mcmc_samples, subgroup_values)["mean"]
})
# Create age effect plot
age_plot <- ggplot(data.frame(age = age_seq, te = te_age)) +
geom_line(aes(x = age, y = te)) +
labs(x = "Standardized Age", y = "Treatment Effect",
title = "Treatment Effect by Age") +
theme_minimal()
# Calculate effects for binary variables
binary_effects <- data.frame(
Variable = c("Anticoagulation", "Diabetes"),
Level = c("No", "Yes"),
Effect = c(
calculate_subgroup_effects(mcmc_samples, list(age = 0, anticoag = 0, diabetes = 0))["mean"],
calculate_subgroup_effects(mcmc_samples, list(age = 0, anticoag = 1, diabetes = 0))["mean"],
calculate_subgroup_effects(mcmc_samples, list(age = 0, anticoag = 0, diabetes = 0))["mean"],
calculate_subgroup_effects(mcmc_samples, list(age = 0, anticoag = 0, diabetes = 1))["mean"]
)
)
# Create binary effects plot
binary_plot <- ggplot(binary_effects, aes(x = Level, y = Effect, fill = Variable)) +
geom_bar(stat = "identity", position = "dodge") +
labs(x = "", y = "Treatment Effect",
title = "Treatment Effects by Binary Covariates") +
theme_minimal()
return(list(age_plot = age_plot, binary_plot = binary_plot))
}
library(tableone)
# Generate synthetic data
rct_data <- generate_synthetic_rct(2000)
head(rct_data)
colnames(rct_data)
rct_data %>% select(-subject_id)
rct_data %>% dplyr::select(-subject_id)
rct_data %>% dplyr::select(-subject_id) %>% colnames()
table1 <- CreateTableOne(vars=variables, strata='treatment', data=rct_data, factorVars = categorical_variables)
variables <- rct_data %>% dplyr::select(-subject_id) %>% colnames()
categorical_variables <- c('gender', 'hypertension', 'diabetes', 'smoking', 'anticoagulant', 'prior_bleeding', 'event')
table1 <- CreateTableOne(vars=variables, strata='treatment', data=rct_data, factorVars = categorical_variables)
print(table1, showAllLevels = T)
library(knitr)
latex_table <- kable(as.data.frame(print(table1, showAllLevels = T)), format='latex', booktabs=T)
print(latex_table)
cat(latex_table, file='table1.tex')
getwd()
setwd('/home/georgetz/Desktop/Classes/Fall 2024/MAT 350 - Bayesian Statistics/Final Project')
getwd()
cat(latex_table, file='table1.tex')
t1 <- print(table1, quote = FALSE, noSpaces = TRUE, showAllLevels = T,
printToggle = F, test = FALSE, explain = T, contdigits=1)
t1
t1 <- print(table1, quote = FALSE, noSpaces = TRUE, showAllLevels = T,
printToggle = F, test = FALSE, explain = T, contdigits=1)
t1_df <- as.data.frame(t1) %>% rownames_to_column(var = "Variable")
# Clean up the Variable names to avoid X.1, X.2, etc.
t1_df$Variable <- make.unique(t1_df$Variable, sep = " ")
# Convert data frame to flextable
table_flex <- flextable(t1_df)
library(flextable)
install.packages('flextable')
library(flextable)
t1 <- print(table1, quote = FALSE, noSpaces = TRUE, showAllLevels = T,
printToggle = F, test = FALSE, explain = T, contdigits=1)
t1_df <- as.data.frame(t1) %>% rownames_to_column(var = "Variable")
# Clean up the Variable names to avoid X.1, X.2, etc.
t1_df$Variable <- make.unique(t1_df$Variable, sep = " ")
# Convert data frame to flextable
table_flex <- flextable(t1_df)
# Customize the flextable (optional)
table_flex <- theme_vanilla(table_flex)
table_flex <- autofit(table_flex)
table_flex
t1_df
as.data.frame(t1)
t1 <- print(table1, quote = T, noSpaces = TRUE, showAllLevels = T,
printToggle = F, test = FALSE, explain = T, contdigits=1)
as.data.frame(t1)
p <- print(table1, printToggle = FALSE, noSpaces = TRUE)
kable(p, format = "latex")
kable(p, format = "latex")
p <- print(table1, printToggle = FALSE, noSpaces = TRUE)
kable(p, format = "latex")
kableone(table1, format='latex')
kable(p, format = "latex")
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=T)
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
library(kableExtra)
library(officer)
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=T)
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
?kbl
library(kableExtra)
variables <- rct_data %>% dplyr::select(-subject_id) %>% colnames()
categorical_variables <- c('gender', 'hypertension', 'diabetes', 'smoking', 'anticoagulant', 'prior_bleeding', 'event')
table1 <- CreateTableOne(vars=variables, strata='treatment', data=rct_data, factorVars = categorical_variables)
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=T)
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
print(kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header')))
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
latex_table <- kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
cat(latex_table, file='table1_output.tex')
print(p)
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=F, test=F)
print(p)
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=F, test=T)
print(p)
latex_table <- kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
cat(latex_table, file='table1_output.tex')
print(p)
variables <- rct_data %>% dplyr::select(-c(subject_id, treatment)) %>% colnames()
categorical_variables <- c('gender', 'hypertension', 'diabetes', 'smoking', 'anticoagulant', 'prior_bleeding', 'event')
table1 <- CreateTableOne(vars=variables, strata='treatment', data=rct_data, factorVars = categorical_variables)
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=F, test=T)
print(p)
latex_table <- kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
cat(latex_table, file='table1_output.tex')
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=T)
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
p <- print(table1, printToggle = F, noSpaces = T, showAllLevels = T, missing=F)
kbl(p, booktabs = T, longtable=T, format = "latex") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
kbl(p, booktabs = T, longtable=T, format = "latex", caption = "Baseline Characteristics by Treatment Group") %>%
kable_styling(latex_options = c('striped', 'repeat_header'))
